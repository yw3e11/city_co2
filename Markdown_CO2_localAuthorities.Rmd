---
title: "EPC Analysis for Portsmouth"
author: "Phil Wu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, out.width="600px", dpi=120)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig_caption = TRUE)
knitr::opts_chunk$set(fig_height = 3) # default, make it bigger to stretch vertical axis
knitr::opts_chunk$set(fig_width = 4) # full width
knitr::opts_chunk$set(fig.align = 'center') # full width
knitr::opts_chunk$set(tidy = TRUE) # tidy up code in case echo = TRUE
options(digits=3) 
# Set start time ----
startTime <- Sys.time() 

myPackages <- c("tidyverse", 
       "lubridate", 
       "zoo", 
       "xts", 
       "chron", 
       "data.table", 
       "scales",
       "DT",
       "fTrading", 
       "data.table", 
       "knitr", 
       "gridExtra", 
       "plotly", 
       "stringr", 
       "kableExtra", 
       "maptools" ,
       "ggmap",
       "ggplot2",
       "RColorBrewer",
       #"plyr", # this library clash with dplyr all the time. 
       "png")
       #"sp" ,
       #"rgdal",
       #"raster", 
       #"rasterVis" ,
       #"rgeos")
       

required_packages <- function(x,y){
 for( i in x ){
   if( ! require( i , character.only = TRUE ) ){
     if( Sys.info()["sysname"] == "Linux" ){
       install.packages( i , repos=y , type="source" , quiet=TRUE , dependencies = TRUE , verbose = FALSE )
     } else {
       install.packages( i , repos=y , quiet=TRUE , dependencies = TRUE , verbose = FALSE )
     }
     require( i , character.only = TRUE, quietly = TRUE )
   }
 }
}

required_packages((myPackages),"http://cran.rstudio.com/")

# When find functions under dplyr (e.g. group_by) not working, try detach the packpage of "plyr"
#detach(package:plyr)

# Housekeeping
#rm(list=ls(all=TRUE)) # remove all objects from workspace

```

**[Note]** _When use `read.csv`, columns with strings will by default be assigned as "factors". Factors are faster in speed, but in this case, would cause all blank cells to be "NA". **Use `"stringAsFactor = FALSE"` to avoid this.**_

```{r, import emission data, include=F}
#read excel directly
#readxl::read_excel("", sheet  , skip = 1, )

co2_raw <- read.csv("emission_2005_2015_r.csv", header = T, sep = ",", stringsAsFactors = FALSE)
head(co2_raw)
```

The `co2_raw` dataset contains the co2 emission of all local authorities from 2005 to 2015. It includes many rows for regions (e.g. Lancashire Total), rather than local authorities. These rows can be identified as the `LAD14CD` column is blank.  First to find out how many of them are included in the dataset. 

**[Note]** _The code `co2_raw$LAD14CD="" ` would directly return results of `TRUE` or `FALSE`. There are several ways to calculate the number of rows with `LAD14CD` as blank. 1) `nrow`, where rows having that cell as blank are `co2_raw[co2_raw$LAD14CD == "",]`. 2) just directly `sum(co2_raw$LAD14CD == "")`._

```{r, include=FALSE}
#str(co2_raw) # str() is similar to class() but returns more information

#length(co2_raw[LAD14CD == ""] ) #this won't work as the results are TRUE or FALSE

#nrow(co2_raw[co2_raw$LAD14CD=="",]) #this is one way of counting the number of rows with blank cell

# Count the number of blank values
n_regionData <- sum(co2_raw$LAD14CD == "")
colnames(co2_raw)
```

It is found that `r n_regionData` rows are for regions so should be removed from dataset. Below are all the columns. 

```{r}
# Compare industry v.s. residential emissions within Greater London
# First to show the header of all columns included in orginal dataset
colnames(co2_raw)
```

```{r, include=F}
co2_la <- co2_raw %>% 
  filter(LAD14CD != "") %>%  # filter out blank names
  mutate(Electricity = A..Industry.and.Commercial.Electricity + F..Domestic.Electricity ) %>% 
  mutate(Gas = B..Industry.and.Commercial.Gas + G..Domestic.Gas ) %>% 
  dplyr::select(Region = Region.Name, 
                City = LAD14NM, Year, 
                Total = Grand.Total, 
                Population, 
                Person = Per.Capita.Emissions..t., 
                Industry = Industry.and.Commercial.Total, 
                Domestic = Domestic.Total, 
                Transport = Transport.Total, 
                Electricity, 
                Gas) %>% 
  as.data.table
  
#co2_la
  
```

The number of all rows left is `r nrow(co2_la)`. The dataset `co2_la` selects key columns including 

```{r}
head(co2_la)
```


```{r, include = T}
n_cities=length(unique(co2_la$City))
```

The diagram below shows the per capital CO2 emissions of Portsmouth (green) and Southampton (red) with all other cities. Total number of cities is `r n_cities`. 

```{r}

#co2_la$category <- "All"
#co2_la$category[co2_la$City == "Southampton"] <- "Southampton"
#co2_la$category[co2_la$City == "Portsmouth"] <- "Southampton"

fig.co2_la <- ggplot() +
  geom_line(data = co2_la, aes(x = Year, y = Person, group = City), colour = "grey", size = 0.5) + 
  geom_line(data = co2_la[City == "Southampton"], aes(x = Year, y = Person), colour = "red")+
  geom_line(data = co2_la[City == "Portsmouth"], aes(x = Year, y = Person), colour = "green") +
  ylab("CO2 per person")  
  #xlab("Year") 
  #theme(legend.position = "right")

fig.co2_la
```


```{r}
fig.cities_boxplot <- ggplot(co2_la, aes(Year, Person, group=Year))+
  geom_boxplot()+
  scale_x_continuous(limits = c(2005, 2015),breaks = c(2005:2015) )

fig.cities_boxplot
```

## Emissions in Portsmouth

```{r}
co2_portsmouth <- co2_la[City == "Portsmouth"]
co2_southampton <- co2_la[City =="Southampton"]
#head(co2_portsmouth)

fig.co2_portsmouth <- ggplot(data = co2_portsmouth)+
  geom_smooth(aes(x=Year, y=Person), alpha = 0.2, size = 0)+
  geom_line(aes(x = Year, y = Person)) +
  geom_point(aes(x = Year, y = Person)) +
  geom_text(aes(x=Year , y=Person, label= round(Person, 1)), vjust=3, size=3   ) +
  scale_y_continuous(sec.axis = sec_axis(~. / co2_portsmouth$Person[co2_portsmouth$Year == 2005], 
                    labels = scales::percent),
                    limits = c(3.5,7), 
                    expand = c(0, 0.1)) + 
  scale_x_continuous(expand = c(0,0.25), breaks = seq(2005,2015,1)) +
  labs(y = expression(Per~capita~CO[2]~emission~(T)), 
       title= "Portsmouth 2005 - 2015") +
  geom_hline(yintercept = co2_portsmouth$Person[co2_portsmouth$Year == 2005], size=0.1, linetype=2)
  #geom_point(data=p_portsmouth, aes(x=p_year, y=p_co2))
  #scale_y_continuous(labels = scales::percent)

#head(co2_portsmouth)
#colnames(co2_portsmouth)
fig.co2_portsmouth

(co2_portsmouth$Person[co2_portsmouth$Year==2005] - co2_portsmouth$Person[co2_portsmouth$Year==2015])/co2_portsmouth$Person[co2_portsmouth$Year==2005]

```



## Compare emission by regions


```{r}
co2_region <- co2_raw %>% 
  filter(LAD14CD != "") %>%  # filter out blank names
  dplyr::select(Region = Region.Name, City = LAD14NM, Year, Total = Grand.Total, Population, Person = Per.Capita.Emissions..t.) %>% 
  group_by(Region, Year) %>% 
  dplyr::summarise(cityCount = length(City), rEmission = sum(Total), rPopulation = sum(Population)) %>% 
  mutate(rPerson = rEmission/rPopulation)

fig.co2_region <- ggplot()+
  geom_line(data = co2_region, aes(x=Year, y=rPerson, group=Region, colour = Region)) +
  scale_y_continuous(sec.axis = sec_axis(~. / max(co2_region$rPerson), 
                    labels = scales::percent))

fig.co2_region
```

## Greater London

Greater London is found to show outstanding results. As a local authority (city), its per capital emission is 30 times greater than that of Portsmouth, but as a region, it has the lowest per capital emission. 

```{r, include=F}
co2_london <- co2_raw %>% 
  filter(LAD14CD != "" & Region.Name=="Greater London") %>%  # filter out blank names
  mutate(Electricity = A..Industry.and.Commercial.Electricity + F..Domestic.Electricity ) %>% 
  mutate(Gas = B..Industry.and.Commercial.Gas + G..Domestic.Gas ) %>% 
  dplyr::select(Region = Region.Name, 
                City = LAD14NM, Year, 
                Total = Grand.Total, 
                Population, 
                Person = Per.Capita.Emissions..t., 
                Industry = Industry.and.Commercial.Total, 
                Domestic = Domestic.Total, 
                Transport = Transport.Total, 
                Electricity, 
                Gas) 

head(co2_london)

```

It has been found that there are `r unique(co2_london$City)` cities within the region of Greater London. 


```{r}
palette_Dark2 <- colorRampPalette(brewer.pal(8, "Dark2"))

cC_londonCities <- length(unique(co2_london$City))

fig.co2_londonCities <- ggplot(co2_london, aes(x=Year, y=Total, fill=City)) +
  geom_bar(stat = "identity")+
  scale_fill_manual(values = palette_Dark2(cC_londonCities))

fig.co2_londonCities
```


## City of London -- londonCity

Two areas within Greater London, the city and Islington, are compared here to see their difference in energy consumption sectors.  

```{r, include=F}
london_2Area <- co2_london %>% 
  filter(City == "City of London" | City =="Islington") %>% 
  dplyr::select(-Region) %>% 
  group_by(City) %>% 
  mutate(d_Industry = percent(round(Industry / Industry[Year == 2005], 2)))

head(london_2Area,20)

```

```{r, include=F}
colnames(london_2Area)
```

[Note] To plot the stacked bar chart, the "wide" table needs to be rearranged into a "long" table. The function "gather" can be used as part of the pipe. 

```{r}
london_2Area_long <- london_2Area %>% 
  dplyr::select(City, Year, Industry, Domestic, Transport) %>% 
  gather(key = Category, value = Emission, -City, -Year) 

fig.co2_2AreasInLondon <- ggplot()+
  geom_bar(data=london_2Area_long, aes(x=Year, y=Emission, fill=Category, group=City), stat = "identity")+
  facet_wrap(~City)+
  scale_x_continuous(breaks = seq(2005,2015, by=2) ) + 
  geom_text(data = london_2Area, aes(x=Year, y=Total, label=round(Total,0), vjust=-1), size = 3, check_overlap = T) + 
  geom_text(data = london_2Area, 
            aes(x=Year, 
                y=Industry/2, 
                label=d_Industry, 
                group = City), 
            size = 3,
            angle = 60 ,
            check_overlap = T) 

fig.co2_2AreasInLondon
```

## All areas excluding London 

It is now revealed that the emission in city of London is significantly higher than that of other areas due to its very low population, as shown in figure below. 

```{r, include=F}
head(co2_la)

population_la <- co2_la %>% 
  dplyr::select(City, Year, Population) %>% 
  group_by(City) %>% 
  summarise(m_Population = mean(Population)) %>% 
  mutate(areaCategory = ifelse(City == "City of London", "London", "Other areas")) 

population_med <- population_la%>% 
  group_by(areaCategory) %>% 
  summarise(mean=mean(m_Population), median=median(m_Population)) 

head(population_la)

fig.cityPopulation_london_vs_others <- ggplot(population_la, aes(x=areaCategory, y=m_Population, group=areaCategory))+
  geom_boxplot() + 
  geom_text(data=population_med, aes(x=areaCategory, y=median, label = paste("median =",round(median,1), "k")), size = 3.5, vjust=-0.5)+ 
  labs(y="City population", x=NULL)
```
```{r}
fig.cityPopulation_london_vs_others
```

The figure below shows the emission from areas outside city of London. 
```{r}
co2_la_excLondon <- co2_la %>% 
  filter(City != "City of London")

fig.city_excLondon <- ggplot()+
  geom_line(data=co2_la_excLondon, aes(x=Year, y=Person, group=City), size = 0.3)+
  labs(y="CO2 per person")

fig.city_excLondon



```

One city has shown a dramatic fall, all the way to a negtive value in CO2 emission. 

```{r, include=F}
# Arrange table (ascending / descending)
arrange(co2_raw, Per.Capita.Emissions..t.)

#Find out the city with lowest (ascending) per capita emission 
arrange(co2_la_excLondon, Person)[1,"City"]
```

## Northumberland

```{r}
co2_northumberland_detailed <- co2_raw %>% 
  filter(LAD14NM == "Northumberland") %>%  # filter out blank names
  dplyr::select(Year, 
         Industry_elec = A..Industry.and.Commercial.Electricity, 
         Industry_gas = B..Industry.and.Commercial.Gas, 
         Industry_install = C..Large.Industrial.Installations, 
         Industry_other = D..Industrial.and.Commercial.Other.Fuels, 
         Industry_agriculture = E..Agriculture, 
         Domestic_ele = F..Domestic.Electricity, 
         Domestic_gas = G..Domestic.Gas, 
         Domestic_other = H..Domestic..Other.Fuels., 
         Transport_ARoad = I..Road.Transport..A.roads., 
         Transport_motorway = J..Road.Transport..Motorways., 
         Transport_minor = K..Road.Transport..Minor.roads., 
         Transport_rail = L..Diesel.Railways, 
         Transport_other = M..Transport.Other, 
         LandUse = N..LULUCF.Net.Emissions) %>% 
  gather(key = Sector, value = Emission, -Year)


cC_northumberland <- length(unique(co2_northumberland_detailed$Sector))

ggplot()+
  geom_bar(data=co2_northumberland_detailed, aes(x=Year, y=Emission, fill=Sector), 
           stat="Identity") + 
  scale_fill_manual(values=palette_Dark2(cC_northumberland))+
  labs(title="Northumberland") +
  theme(legend.position = "right")+
  geom_hline(yintercept = 0)+
  scale_x_continuous(limits=c(2004.5,2015.5), breaks=c(2005:2015,1))

```




## Portsmouth - emission change projection

```{r}
fig.co2_portsmouth



head(co2_portsmouth)

colnames(co2_raw)
```


```{r}
palette_RYG <- colorRampPalette(brewer.pal(8, "RdYlGn"))


co2_portsmouth_category <- co2_portsmouth %>% 
  dplyr::select(Year, Industry, Domestic, Transport) %>% 
  gather(key = Category, value = Emission, -Year)

head(co2_portsmouth_category)

cC_portsmouth_category <- length(unique(co2_portsmouth_category$Category))

fig.Portsmouth_category <- ggplot(data = co2_portsmouth_category)+
  geom_bar(aes(x=Year, y=Emission, fill= Category), stat="Identity")+
  scale_fill_manual(values = palette_RYG(cC_portsmouth_category))+
  theme(legend.position = "none")

#fig.Portsmouth_category

co2_portsmouth_detailed <- co2_raw %>% 
  filter(LAD14NM == "Portsmouth") %>%  # filter out blank names
  dplyr::select(Year, 
         `Industry/commericial electricity` = A..Industry.and.Commercial.Electricity, 
         `Industry/commericial gas` = B..Industry.and.Commercial.Gas, 
         `Large industry installations` = C..Large.Industrial.Installations, 
         `Industry/commercial other fuels` = D..Industrial.and.Commercial.Other.Fuels, 
         `Agriculture` = E..Agriculture, 
         `Domestic electricity` = F..Domestic.Electricity, 
         `Domestic gas` = G..Domestic.Gas, 
         `Domestic other fuels` = H..Domestic..Other.Fuels., 
         `Transport A road` = I..Road.Transport..A.roads., 
         `Transport motorway` = J..Road.Transport..Motorways., 
         `Transport minor roads` = K..Road.Transport..Minor.roads., 
         `Railways` = L..Diesel.Railways, 
         `Transport other` = M..Transport.Other, 
         `Land use` = N..LULUCF.Net.Emissions) %>% 
  gather(key = Sector, value = Emission, -Year)

cC_portsmouth_detailed <- length(unique(co2_portsmouth_detailed$Sector))

fig.Portsmouth_detailed <- ggplot(data=co2_portsmouth_detailed)+
  geom_bar(aes(x=Year, y=Emission, fill=Sector), 
           stat="Identity") + 
  scale_fill_manual(values=palette_Dark2(cC_portsmouth_detailed))+
  theme(legend.position = "right")



#fig.Portsmouth_detailed

grid.arrange(fig.Portsmouth_category, fig.Portsmouth_detailed, ncol=2, widths=c(1,2), top = "Portsmouth total emission (tCO2e) 2005 - 2015")


```

Remove the insignificant energy sectors such as "transport other". 

```{r}

portsmouth_annual <- co2_portsmouth_detailed %>% 
  group_by(Year) %>% 
  summarise(Annual_co2 = sum(Emission)) %>% 
  summarise(mean = mean(Annual_co2))

# Total of all sectors that have weight of over 1%
co2_portsmouth_detailed %>% 
  group_by(Sector) %>% 
  summarise(Mean = mean(Emission)/portsmouth_annual$mean) %>% 
  filter(Mean>0.01) %>% 
  summarise(Sum = sum(Mean))

portsmouth_mainSector_list <-co2_portsmouth_detailed %>% 
  group_by(Sector) %>% 
  summarise(Mean = mean(Emission)/portsmouth_annual$mean) %>% 
  filter(Mean>0.01) 

portsmouth_mainSector <- co2_portsmouth_detailed %>% 
  filter(Sector %in% portsmouth_mainSector_list$Sector)

portsmouth_mainSector

ggplot(data=portsmouth_mainSector)+
  geom_area(aes(x=Year, y=Emission, fill=Sector), 
           stat="Identity") + 
  geom_line(aes(x=Year, y=Emission, group = Sector), size=0.1, position="stack")+
  #geom_point(aes(x=Year, y=Emission, group = Sector), size=0.1, alpha=0.2, position="stack")+
  scale_fill_brewer(palette = "Dark2")+
  scale_x_continuous(breaks = seq(2005,2015,1))+
  labs(y=expression(CO[2]~emission~","~kT), title="Portsmouth 2005 - 2015")+
  theme(legend.position = "right")
```


```{r}
fig.Portsmouth_detailed
```



```{r}
ggplot(data=co2_portsmouth_detailed)+
  geom_bar(aes(x=Year, y=Emission, fill=Sector), 
           stat="Identity") + 
  geom_smooth(data=co2_portsmouth_category, aes(x=Year, y=Emission, group=Category), alpha=0, colour="blue", size=0.5, position = "stack")+
  scale_fill_manual(values=palette_RYG(cC_portsmouth_detailed))+
  theme(legend.position = "right")


```

```{r}

co2Reduction_portsmouth <- co2_portsmouth_category %>% 
  group_by(Category) %>% 
  mutate(diff = percent(round( (Emission - Emission[Year==2005])/Emission[Year==2005] ,2)) )%>% 
  filter(Year == 2015) %>% 
  arrange(desc(Category))

co2Reduction_portsmouth

arrange(co2Reduction_portsmouth, Category)

ggplot(data=co2_portsmouth_detailed)+
  geom_bar(aes(x=Year, y=Emission, fill=Sector), 
           stat="Identity") + 
  geom_line(data=co2_portsmouth_category, aes(x=Year, y=Emission, group=Category), alpha=1, colour="blue", size=0.5, position = "stack")+
  scale_fill_manual(values=palette_RYG(cC_portsmouth_detailed))+
  theme(legend.position = "right")+
  scale_x_continuous(limits = c(2004.5, 2017.2) , breaks = c(2005:2015,1), expand = c(0,0.25))+
  geom_text(data=co2Reduction_portsmouth, aes(x=2015, y=Emission, label=paste(Category,"\n",diff, sprintf('\u2193'))), position = position_stack(vjust=0.5), hjust=-0.3)

```



```{r}
ggplot(data = co2_portsmouth_category , aes(x=Year, y=Emission, fill= Category))+
  geom_bar(stat="Identity")+
  scale_fill_brewer(palette = "Paired")+
  scale_x_continuous(limits = c(2004.5, 2016.9) , breaks = c(2005:2015,1), expand = c(0,0.25))+
  theme(legend.position = "right")+
  geom_text(data=co2Reduction_portsmouth, aes(x=2015, y=Emission, label=paste(diff, sprintf('\u2193'))), position = position_stack(vjust=0.5), hjust=-0.6)


```

## Regression

The first attempt was to fit total co2 emission with year, and it gives an R square of 0.862. 

```{r, includ = F}
head(co2_portsmouth)
fit <- lm(Total ~ Year, data = co2_portsmouth)
summary(fit)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
```
The second attempt was to use "per capita emission", which gives a better R square of 0.918. Considering the prediction of population is another level of difficulty, the variable "population" is not included in this model. 

```{r}
fit_portsmouth <- lm(Person ~ Year, co2_portsmouth)
summary(fit_portsmouth)
fit_portsmouth

```

The projection of per capita emission till 2030 is plotted together with the actual emissions. 

```{r}
p_year <- data.frame(Year = c(1970:2050))

pred_co2_portsmouth <- data.frame(pred_co2 = predict(fit_portsmouth, p_year), Year = p_year)

ggplot()+
  geom_point(data=pred_co2_portsmouth, aes(x=Year, y=pred_co2), colour="red")  + 
  geom_line(data = co2_portsmouth,aes(x = Year, y = Person)) +
  geom_point(data = co2_portsmouth, aes(x = Year, y = Person))+
  geom_smooth(data = co2_portsmouth, aes(x=Year, y=Person), size=0, colour="blue")+
  scale_x_continuous( limits = c(2005,2050), breaks = seq(from = 2005, to=2050, by=5) )+
  scale_y_continuous(limits=c(0,7), name = "Per capita emission")


```


## UK data to compare

Use the UK national dataset (from 1970 to 2015) to train a linear model. The results show a very good fit with r square of 0.92. But is this model the same with the previous one which was obtained by 10 years' data (2005 - 2015)? 

```{r}
uk_emission <- read_csv("../Emissions/UK_total_1070-2015_2.csv", col_names = T)

uk_emission_post2005 <- uk_emission %>% 
  filter(Year >= 2005)

#head(uk_emission_post2005)

fit_uk_all <- lm(`Total emission` ~ Year, uk_emission)
fit_uk_post2005 <- lm(`Total emission` ~ Year, uk_emission_post2005)

summary(fit_uk_all)
summary(fit_uk_post2005)

```

## plot and check

In the figure below, two models that are obtained from 45-year v.s. 10-year data are compared. 

```{r}
p_year_2005 <- data.frame(Year = c(2005:2050))

p_uk_all <- data.frame(Emission_est = predict(fit_uk_all, p_year), Year = p_year, Source = "1970-2015")
p_uk_post2005 <- data.frame(Emission_est = predict(fit_uk_post2005, p_year_2005), Year = p_year_2005, Source = "2005-2015")

p_uk <- rbind(p_uk_all, p_uk_post2005)
p_scenario <- p_uk %>% 
  filter(Year == 2050 | Year ==2030) %>% 
  mutate(Emission_est = round(Emission_est, 0 ))

ggplot()+
  geom_rect(aes(xmin=2005, xmax=2015, ymin=-Inf, ymax=Inf), fill="grey", alpha=0.6)+
  geom_point(data=uk_emission, aes(x=Year, y=`Total emission`), colour="black") +
  geom_line(data=p_uk, aes(x=Year, y=Emission_est, group=Source, colour=Source)) +
  geom_vline(xintercept = c(2030, 2050), size=0.1)+
  geom_hline(yintercept = 0, size=0.3) +
  geom_point(dat=p_scenario, aes(x=Year, y=Emission_est, colour=Source)) +
  geom_text(data=p_scenario, aes(x=Year, y=Emission_est, label=Emission_est, colour=Source),
            vjust=-1, hjust=-0.2 )+
  scale_x_continuous( limits = c(1970,2054), breaks = seq(1970, 2050, 10) )+
  labs(title = "UK emission 1970 - 2015", 
       y = expression(Total~emission~Mt~CO[2][e]), 
       colour="Data range")

```

## Make prediction by sectors


Columns included in the dataset of `co2_portsmouth_category` and `co2_portsmouth_detailed` are: 

```{r}
head(co2_portsmouth_category,30)
head(co2_portsmouth_detailed)
```



```{r}
library(lme4)

fits_portsmouth <- lmList(Emission ~ Year | Category, data = co2_portsmouth_category)
fits_portsmouth
summary(fits_portsmouth)

```

```{r}
fits_portsmouth <- plyr::dlply(co2_portsmouth_category, "Category", function(x)
  lm(Emission ~ Year, data=x)) # results are a list of objects

lapply(fits_portsmouth, summary)

pred_portsmouth <- lapply(fits_portsmouth, function(x)
  data.frame(Emission_est = predict(x, p_year_2005), Year = p_year_2005)) # results are a list of data.frames

# melt the list of results into a long table
p_portsmouth <- melt(pred_portsmouth, id = c("Year", "Emission_est") ) %>%
  setnames(c("Year", "Emission", "Category")) %>% 
  mutate(Emission_r = ifelse(Emission < 0, 0, Emission))

ggplot()+
  geom_area(data=co2_portsmouth_category, aes(x=Year, y=Emission, fill=Category))+
  geom_point(data=co2_portsmouth_category, aes(x=Year, y=Emission, group=Category), position = position_stack(), size=0.2)+
  scale_fill_brewer(palette = "Paired") +
  geom_line(data = p_portsmouth, aes(x=Year, y=Emission_r, group=Category, colour=Category), position = position_stack())
```

```{r}
colnames(co2_portsmouth_category)
head(co2_portsmouth)


```

## Prediction by sector + fuel type 

* `pp` for per capita

* 

```{r}

population_portmouth <- co2_portsmouth %>% 
  dplyr::select(Year, Population ) 

co2_person_portsmouth_detailed <- co2_portsmouth_detailed %>% 
  left_join(population_portmouth, by = "Year") %>% 
  mutate(Emission_person = Emission / Population) %>% 
  dplyr::select(Year, Emission_person, Sector)

co2_person_portsmouth_category <- co2_portsmouth_category %>% 
  left_join(population_portmouth, by = "Year") %>% 
  mutate(Emission_person = Emission / Population) %>% 
  dplyr::select(Year, Emission_person, Category)


fits_person_portsmouth <- plyr::dlply(co2_person_portsmouth_category, "Category", function(x)
  lm(Emission_person ~ Year, data=x)) # results are a list of objects

lapply(fits_person_portsmouth, summary)

pred_co2_person_portsmouth <- lapply(fits_person_portsmouth, function(x)
  data.frame(Pred_co2_person = predict(x, p_year_2005), Year = p_year_2005)) # results are a list of data.frames

# melt the list of results into a long table
pred_co2_person_portsmouth <- melt(pred_co2_person_portsmouth, id = c("Year", "Pred_co2_person") ) %>%
  setnames(c("Year", "Pred_co2_person", "Category")) %>% 
  mutate(Pred_co2_person = ifelse(Pred_co2_person < 0, 0, Pred_co2_person))

ggplot()+
  geom_area(data=co2_person_portsmouth_category, aes(x=Year, y=Emission_person, fill=Category))+
  geom_line(data=co2_person_portsmouth_category, aes(x=Year, y=Emission_person, group=Category), size=0.4, position="stack", colour="white")+
  geom_line(data=pred_co2_person_portsmouth, aes(x=Year, y=Pred_co2_person, colour=Category), position="stack", size=1, linetype=2)+    
  scale_fill_brewer(palette = "Paired")+
  geom_point(data=pred_co2_portsmouth, aes(x=Year, y=pred_co2), colour="black", alpha=1, shape=8, size=2)+
  scale_x_continuous(limits=c(2005,2050))+
  scale_y_continuous(limits=c(0,7), name = "Per capita CO2 (T / year)")+
  labs(title="Portsmouth prediction")


```



```{r}

grid.arrange(fig.Portsmouth_category, fig.Portsmouth_detailed, ncol=2, widths=c(1,2))

```

```{r}
head(co2_portsmouth)
```

```{r}
head(co2_person_portsmouth_detailed)
co2_portsmouth_detailed %>% 
  left_join(population_portmouth, by="Year") %>% 
  mutate(Emission_person = Emission / Population) %>% 
  dplyr::select(Year, Sector, Emission_person) -> co2_person_portsmouth_detailed


fits_person_portsmouth_sector <- plyr::dlply(co2_person_portsmouth_detailed, "Sector", function(x)
  lm(Emission_person ~ Year, data=x)) # results are a list of objects

lapply(fits_person_portsmouth_sector, summary)

pred_co2_person_portsmouth_sector <- lapply(fits_person_portsmouth_sector, function(x) 
  data.frame(pred_co2 = predict(x, p_year_2005), Year=p_year_2005))

pred_co2_person_portsmouth_sector <- melt(pred_co2_person_portsmouth_sector, id=c("Year", "pred_co2")) %>% 
  setnames(c("Year", "Pred_co2_person", "Sector")) %>% 
  mutate(pred_co2= ifelse(Pred_co2_person < 0, 0, Pred_co2_person))

pred_co2_person_portsmouth_sector


ggplot()+
  geom_area(data=co2_person_portsmouth_detailed, aes(x=Year, y=Emission_person, fill=Sector))+
  geom_point(data=pred_co2_person_portsmouth_sector,aes(x=Year,y=pred_co2,colour=Sector),position="stack")+
  geom_point(data=pred_co2_portsmouth, aes(x=Year, y=pred_co2), colour="black", alpha=1, shape=8, size=2)+
  scale_x_continuous(limits=c(2005,2050)) +
  scale_y_continuous(limits=c(0,7))
```


```{r}
summary(fits_person_portsmouth_sector$`Domestic electricity`)
summary(fits_person_portsmouth_sector$`Domestic electricity`)$r.square
```



## 5 example cities
London, Southampton, Birminghamd, Liverpool, Portsmouth
```{r}
cityExample_list <- c("London", "Southampton", "Birmingham", "Liverpool", "Portsmouth")
cityExample <- co2_la %>% 
  filter(City %in% cityExample_list | Region == "Greater London" ) %>% 
  mutate(City=ifelse(Region == "Greater London", "Greater London", City)) %>% 
  group_by(City, Year) %>% 
  summarise(Total = sum(Total), Population = sum(Population)) %>% 
  mutate(perCapita=Total/Population) 

ggplot(data=cityExample)+
  geom_line(aes(x=Year, y=perCapita, group=City, colour=City))+
  geom_point(aes(x=Year, y=perCapita, group=City, colour=City))+
  scale_color_brewer(palette = "Set1")+
  scale_x_continuous(breaks = seq(2005,2015,1))+
  labs(y=expression(Per~capita~CO[2]~emissions~"(T)"))+ 
  theme(legend.position = c(.98, .98),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6) )

cityExample
unique(co2_la$City)

```
Average reduction from 2005 to 2015

```{r}
cityExample %>% 
  group_by(Year) %>% 
  summarise(Average=mean(perCapita)) %>% 
  mutate(Reduction = percent( (Average[Year == 2005] -Average)/Average[Year==2005]))
```
















































